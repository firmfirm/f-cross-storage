<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../promise-to-retry/promise-to-retry.html">
<link rel="import" href="../cross-storage/imports/client.html">

<!--
`<f-cross-storage>` is a wrapper element for [cross-storage](https://github.com/zendesk/cross-storage) client,
built with Polymer.

Example:

    <f-cross-storage hub-url="https://..." key="mySetting" value="{{myProperty}}" pull></f-cross-storage>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="f-cross-storage">

  <script>
  (function() {
    var clients = {};
    Polymer({
      is: 'f-cross-storage',

      properties: {
        /*
         * URL to your cross-storage hub
         */
        hubUrl: String,

        /*
         * Key of stored object
         */
        key: String,

        /*
         * Automatically pull object from storage and set it to `value` property
         */
        pull: Boolean,

        /*
         * Automatically set object from `value` property to storage (triggered on change)
         */
        push: Boolean,

        /*
         * Stored value (could go out of sync if you do not use `push`)
         */
        value: {
          type: Object,
          notify: true
        },

        _client: Object
      },

      observers: [
        '_connect(hubUrl)',
        '_pull(pull, _client, key)',
        '_push(push, _client, key, value)'
      ],

      _connect: function(url) {
        if (!clients[url]) {
          clients[url] = new CrossStorageClient(url);
        }
        this._client = clients[url];
      },

      _pull: function(ok, client, key) {
        if (!ok) return;
        PromiseToRetry.ensure(() =>
                client.onConnect()
                      .then(() => client.get(key))
                      .then((val) => this.value = val), this._fail.bind(this));
      },

      _push: function(ok, client, key, value) {
        if (!ok) return;
        PromiseToRetry.ensure(() =>
                client.onConnect()
                      .then(() => client.set(key, value)), this._fail.bind(this));
      },

      /**
       * The `f-cross-storage-error` event is fired whenever element fails to
       * retrieve of set value in cross-storage. Will automatically retry after
       * `time` specified in event's `detail` (in milliseconds).
       *
       * @event f-cross-storage-error
       * @detail {{tries: Number, wait: Number, error: Object}}
       */

      _fail: function(detail) { this.fire('f-cross-storage-error', detail); }
    });
  })();
  </script>
</dom-module>
